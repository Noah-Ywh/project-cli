# CD CLI - ç®€æ˜“éƒ¨ç½²å·¥å…·

ä¸€ä¸ªç®€æ˜“çš„éƒ¨ç½²å·¥å…·ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†å’Œé›¶åœæœºéƒ¨ç½²ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ ä¸€é”®éƒ¨ç½²ï¼šæœ¬åœ°æ„å»º â†’ å‹ç¼© â†’ ä¸Šä¼  â†’ è§£å‹ â†’ é‡å¯æœåŠ¡
- ğŸ“¦ ç‰ˆæœ¬ç®¡ç†ï¼šæ”¯æŒç‰ˆæœ¬å·ç®¡ç†ï¼Œä¿ç•™å¤šä¸ªå†å²ç‰ˆæœ¬
- ğŸ”„ é›¶åœæœºéƒ¨ç½²ï¼šä½¿ç”¨è½¯é“¾æ¥å®ç°åŸå­æ€§åˆ‡æ¢
- âª å¿«é€Ÿå›æ»šï¼šä¸€é”®å›æ»šåˆ°ä»»æ„å†å²ç‰ˆæœ¬
- ğŸ“ ç‰ˆæœ¬åˆ—è¡¨ï¼šæŸ¥çœ‹æœåŠ¡å™¨ä¸Šæ‰€æœ‰å·²éƒ¨ç½²ç‰ˆæœ¬
- ğŸ”’ å®‰å…¨è¿æ¥ï¼šæ”¯æŒå¯†ç å’Œç§é’¥è®¤è¯
- ğŸ”„ PM2 é›†æˆï¼šè‡ªåŠ¨é‡å¯ PM2 åº”ç”¨
- ğŸ“ é…ç½®çµæ´»ï¼šæ”¯æŒéƒ¨ç½²å‰åæ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤
- ğŸ¯ æ–‡ä»¶è¿‡æ»¤ï¼šæ”¯æŒæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶

## å®‰è£…

### å…¨å±€å®‰è£…

```bash
npm install -g @noahyu/cd-cli
```

å®‰è£…åå¯åœ¨ä»»ä½•é¡¹ç›®ä¸­ä½¿ç”¨ `pcli-cd` å‘½ä»¤ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. åœ¨é¡¹ç›®ä¸­åˆå§‹åŒ–é…ç½®

```bash
cd your-project
pcli-cd init
```

è¿™ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `pcli-cd.config.js` é…ç½®æ–‡ä»¶ã€‚

- **é‡è¦** `pcli-cd.config.js` æ–‡ä»¶ä¸åº”è¯¥æäº¤åˆ° Git

### 2. éƒ¨ç½²é¡¹ç›®

```bash
pcli-cd deploy
# æˆ–è€…ä½¿ç”¨åˆ«å
pcli-cd cd

# æŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²
pcli-cd deploy --version v1.0.0
```

### 3. æŸ¥çœ‹ç‰ˆæœ¬åˆ—è¡¨

```bash
pcli-cd list
# æˆ–è€…ä½¿ç”¨åˆ«å
pcli-cd ls
```

### 4. å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬

```bash
pcli-cd rollback
# æˆ–è€…ä½¿ç”¨åˆ«å
pcli-cd rb

# ç›´æ¥æŒ‡å®šç‰ˆæœ¬å›æ»š
pcli-cd rollback --version v1.0.0
```

## éƒ¨ç½²æ¶æ„

éƒ¨ç½²åçš„æœåŠ¡å™¨ç›®å½•ç»“æ„ï¼š

```
/var/www/your-app/
â”œâ”€â”€ .output -> .output-v1.0.1     # è½¯é“¾æ¥æŒ‡å‘å½“å‰ç‰ˆæœ¬
â”œâ”€â”€ .output-v1.0.0/               # å†å²ç‰ˆæœ¬
â”œâ”€â”€ .output-v1.0.1/               # å½“å‰ç‰ˆæœ¬
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ index.mjs             # PM2 å¯åŠ¨æ–‡ä»¶
â””â”€â”€ .output-v1.0.2/               # æ–°ç‰ˆæœ¬ (å¦‚æœæœ‰)
```

PM2 é…ç½®å§‹ç»ˆæŒ‡å‘è½¯é“¾æ¥ `.output/server/index.mjs`ï¼Œè¿™æ ·åˆ‡æ¢ç‰ˆæœ¬æ—¶æ— éœ€ä¿®æ”¹ PM2 é…ç½®ã€‚

## é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶ `pcli-cd.config.js` ç¤ºä¾‹ï¼š

> **é‡è¦** `pcli-cd.config.js` æ–‡ä»¶ä¸åº”è¯¥æäº¤åˆ° Git

```javascript
// pcli-cd éƒ¨ç½²é…ç½®æ–‡ä»¶
export default {
  // æ„å»ºå‘½ä»¤ (å¯é€‰)
  buildCommand: 'npm run build',

  // æ„å»ºè¾“å‡ºç›®å½•
  buildDir: '.output',

  // ç‰ˆæœ¬å· (å¯é€‰ï¼Œä¸æŒ‡å®šä¼šåœ¨éƒ¨ç½²æ—¶è¯¢é—®)
  version: 'v1.0.0',

  // æœåŠ¡å™¨é…ç½®
  server: {
    host: '192.168.1.100',
    port: 22,
    username: 'root',
    password: 'your-password', // å¯†ç æˆ–ç§é’¥äºŒé€‰ä¸€
    // privateKey: '/path/to/private/key',
    deployPath: '/var/www/your-app',
  },

  // PM2 é…ç½® (å¯é€‰)
  pm2: {
    appName: 'your-app-name',
    restart: true,
  },

  // æ’é™¤çš„æ–‡ä»¶ (å¯é€‰) - ä½œç”¨äºæ„å»ºäº§ç‰©ç›®å½•
  // è¯·æ ¹æ®æ„å»ºè¾“å‡ºçš„å®é™…å†…å®¹è°¨æ…é…ç½®
  excludeFiles: [
    // '**/*.map',        // Source Map æ–‡ä»¶
    // '**/.DS_Store',    // macOS ç³»ç»Ÿæ–‡ä»¶
    // '**/Thumbs.db'     // Windows ç¼©ç•¥å›¾ç¼“å­˜
  ],

  // éƒ¨ç½²å‰å‘½ä»¤ (å¯é€‰)
  beforeDeploy: ['npm run test'],

  // éƒ¨ç½²åå‘½ä»¤ (å¯é€‰)
  afterDeploy: ['npm install --production'],
}
```

## é…ç½®é€‰é¡¹

| é€‰é¡¹                | ç±»å‹     | å¿…å¡« | è¯´æ˜                             |
| ------------------- | -------- | ---- | -------------------------------- |
| `buildCommand`      | string   | å¦   | æ„å»ºå‘½ä»¤ï¼Œå¦‚ "npm run build"     |
| `buildDir`          | string   | æ˜¯   | æ„å»ºè¾“å‡ºç›®å½•ï¼Œå¦‚ ".output"       |
| `version`           | string   | å¦   | ç‰ˆæœ¬å·ï¼Œä¸æŒ‡å®šä¼šåœ¨éƒ¨ç½²æ—¶è¯¢é—®     |
| `server.host`       | string   | æ˜¯   | æœåŠ¡å™¨åœ°å€                       |
| `server.port`       | number   | å¦   | SSH ç«¯å£ï¼Œé»˜è®¤ 22                |
| `server.username`   | string   | æ˜¯   | ç”¨æˆ·å                           |
| `server.password`   | string   | å¦   | å¯†ç                              |
| `server.privateKey` | string   | å¦   | ç§é’¥è·¯å¾„                         |
| `server.deployPath` | string   | æ˜¯   | æœåŠ¡å™¨éƒ¨ç½²è·¯å¾„                   |
| `pm2.appName`       | string   | å¦   | PM2 åº”ç”¨åç§°                     |
| `pm2.restart`       | boolean  | å¦   | æ˜¯å¦é‡å¯ PM2 åº”ç”¨                |
| `excludeFiles`      | string[] | å¦   | æ’é™¤çš„æ–‡ä»¶æ¨¡å¼ï¼ˆç›¸å¯¹äºæ„å»ºç›®å½•ï¼‰ |
| `beforeDeploy`      | string[] | å¦   | éƒ¨ç½²å‰æ‰§è¡Œçš„å‘½ä»¤                 |
| `afterDeploy`       | string[] | å¦   | éƒ¨ç½²åæ‰§è¡Œçš„å‘½ä»¤                 |

## å‘½ä»¤è¯¦è§£

### deploy (cd)

éƒ¨ç½²é¡¹ç›®åˆ°æœåŠ¡å™¨

```bash
pcli-cd deploy [options]

Options:
  -c, --config <config>    é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./pcli-cd.config.js)
  -v, --version <version>  æŒ‡å®šç‰ˆæœ¬å·
  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

### list (ls)

åˆ—å‡ºæœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰ç‰ˆæœ¬

```bash
pcli-cd list [options]

Options:
  -c, --config <config>    é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./pcli-cd.config.js)
  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

### rollback (rb)

å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬

```bash
pcli-cd rollback [options]

Options:
  -c, --config <config>    é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./pcli-cd.config.js)
  -v, --version <version>  å›æ»šåˆ°çš„ç‰ˆæœ¬å·
  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

### init

åˆå§‹åŒ–é…ç½®æ–‡ä»¶

```bash
pcli-cd init
```

## ä½¿ç”¨åœºæ™¯

### 1. Nuxt 3 é¡¹ç›®éƒ¨ç½²

```javascript
// Nuxt.js é¡¹ç›®é…ç½®
export default {
  buildCommand: 'npm run build',
  buildDir: '.output',
  server: {
    host: 'your-server.com',
    username: 'root',
    password: 'your-password',
    deployPath: '/var/www/nuxt-app',
  },
  pm2: {
    appName: 'nuxt-app',
    restart: true,
  },
  excludeFiles: [
    // æ³¨æ„ï¼šä»¥ä¸‹è·¯å¾„ç›¸å¯¹äº .output ç›®å½•
    // è¯·æ ¹æ®å®é™…æ„å»ºäº§ç‰©å†…å®¹è°ƒæ•´
    'src/**', // å¦‚æœæºç è¢«å¤åˆ¶åˆ°è¾“å‡ºç›®å½•
    '**/.DS_Store', // macOS ç³»ç»Ÿæ–‡ä»¶
  ],
}
```

### 2. Node.js API é¡¹ç›®éƒ¨ç½²

```javascript
// Node.js API é¡¹ç›®é…ç½®
export default {
  buildCommand: 'npm run build',
  buildDir: 'dist',
  server: {
    host: 'your-server.com',
    username: 'root',
    privateKey: '~/.ssh/id_rsa',
    deployPath: '/var/www/api'
  },
  pm2: {
    appName: 'api-server',
    restart: true
  },
  excludeFiles: [
    // æ³¨æ„ï¼šä»¥ä¸‹è·¯å¾„ç›¸å¯¹äº dist ç›®å½•
    // è¯·æ ¹æ®å®é™…æ„å»ºäº§ç‰©å†…å®¹è°ƒæ•´
    'src/**',         // å¦‚æœæºç è¢«å¤åˆ¶åˆ°è¾“å‡ºç›®å½•
    '**/.DS_Store', // macOS ç³»ç»Ÿæ–‡ä»¶
  ]
  afterDeploy: [
    'npm install --production'
  ]
}
```

## excludeFiles é…ç½®è¯´æ˜

âš ï¸ **é‡è¦æé†’**ï¼š`excludeFiles` ä½œç”¨äº**æ„å»ºäº§ç‰©ç›®å½•**ï¼ˆå¦‚ `dist/`ã€`.output/` ç­‰ï¼‰ï¼Œä¸æ˜¯é¡¹ç›®æ ¹ç›®å½•ã€‚

### å·¥ä½œåŸç†

1. é¦–å…ˆæ‰§è¡Œ `buildCommand` ç”Ÿæˆæ„å»ºäº§ç‰©åˆ° `buildDir`
2. ç„¶åå¯¹ `buildDir` ç›®å½•è¿›è¡Œå‹ç¼©ï¼Œæ­¤æ—¶åº”ç”¨ `excludeFiles` è§„åˆ™
3. å°†å‹ç¼©åŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨

### é…ç½®å»ºè®®

```javascript
// âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸ºæ’é™¤çš„æ˜¯é¡¹ç›®æ ¹ç›®å½•æ–‡ä»¶
export default {
  excludeFiles: ['src/**', 'node_modules/**']
}

// âœ… æ­£ç¡®ç†è§£ï¼šæ’é™¤çš„æ˜¯æ„å»ºç›®å½•å†…çš„æ–‡ä»¶
export default {
  excludeFiles: [
    // åªæœ‰å½“è¿™äº›æ–‡ä»¶ç¡®å®å‡ºç°åœ¨æ„å»ºç›®å½•ä¸­ï¼Œä¸”ç¡®è®¤ä¸éœ€è¦æ—¶æ‰æ’é™¤
    '**/*.map',        // Source Map æ–‡ä»¶ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰
    '**/.DS_Store',    // macOS ç³»ç»Ÿæ–‡ä»¶
    '**/Thumbs.db'     // Windows ç¼©ç•¥å›¾ç¼“å­˜
  ]
}
```

### æ³¨æ„äº‹é¡¹

- **è¿è¡Œæ—¶ä¾èµ–**ï¼šæŸäº›æ¡†æ¶ï¼ˆå¦‚ Nuxtã€Next.jsï¼‰çš„æ„å»ºäº§ç‰©å¯èƒ½åŒ…å«å¿…éœ€çš„ `node_modules`
- **å»ºè®®**ï¼šåˆæ¬¡ä½¿ç”¨æ—¶ä¿æŒ `excludeFiles: []`ï¼Œè§‚å¯Ÿæ„å»ºäº§ç‰©å†…å®¹åå†é…ç½®

## ç‰ˆæœ¬ç®¡ç†

### é›¶åœæœºéƒ¨ç½²æµç¨‹

1. æ„å»ºé¡¹ç›®åˆ°æœ¬åœ° `.output` ç›®å½•
2. å‹ç¼©å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ–°ç‰ˆæœ¬ç›®å½• `.output-v1.0.1`
3. åœ¨æ–°ç‰ˆæœ¬ç›®å½•æ‰§è¡Œéƒ¨ç½²åå‘½ä»¤ï¼ˆå¦‚å®‰è£…ä¾èµ–ï¼‰
4. åŸå­æ€§åˆ‡æ¢è½¯é“¾æ¥ `.output` æŒ‡å‘æ–°ç‰ˆæœ¬ç›®å½•
5. é‡å¯ PM2 åº”ç”¨
6. æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬ï¼‰

### ç‰ˆæœ¬å‘½åè§„åˆ™

- è‡ªåŠ¨ç”Ÿæˆï¼š`v20250820-114530`ï¼ˆåŸºäºæ—¶é—´æˆ³ï¼‰
- æ‰‹åŠ¨æŒ‡å®šï¼š`v1.0.0`ã€`v2.1.3` ç­‰
- ç‰ˆæœ¬å·å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œå»ºè®®ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬

### å›æ»šæœºåˆ¶

å›æ»šåªéœ€è¦åˆ‡æ¢è½¯é“¾æ¥æŒ‡å‘ï¼Œæ— éœ€é‡æ–°ä¸Šä¼ æ–‡ä»¶ï¼Œé€Ÿåº¦æå¿«ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
pcli-cd list

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
pcli-cd rollback --version v1.0.0

# äº¤äº’å¼é€‰æ‹©ç‰ˆæœ¬å›æ»š
pcli-cd rollback
```

## é…ç½®æ–‡ä»¶

æ¯ä¸ªé¡¹ç›®åªéœ€è¦ä¸€ä¸ª `pcli-cd.config.js` é…ç½®æ–‡ä»¶ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è¯»å–å½“å‰ç›®å½•ä¸‹çš„é…ç½®ã€‚

âš ï¸ **é‡è¦æé†’** `pcli-cd.config.js` æ–‡ä»¶ä¸åº”è¯¥æäº¤åˆ° Git

## æ³¨æ„äº‹é¡¹

- **å…¨å±€å®‰è£…åé¦–æ¬¡ä½¿ç”¨**ï¼šå®‰è£…åå¯åœ¨ä»»æ„ç›®å½•ä½¿ç”¨ `pcli-cd` å‘½ä»¤
- **é…ç½®æ–‡ä»¶ä½ç½®**ï¼šæ¯ä¸ªé¡¹ç›®æ ¹ç›®å½•éœ€è¦æœ‰ `pcli-cd.config.js` é…ç½®æ–‡ä»¶
- ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£… `unzip` å‘½ä»¤
- å¦‚æœä½¿ç”¨ PM2ï¼Œç¡®ä¿æœåŠ¡å™¨å·²å®‰è£… PM2
- ç§é’¥æ–‡ä»¶éœ€è¦æœ‰æ­£ç¡®çš„æƒé™ (600)
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç§é’¥è®¤è¯è€Œéå¯†ç 
- PM2 é…ç½®æ–‡ä»¶ä¸­çš„å¯åŠ¨è·¯å¾„åº”è¯¥æŒ‡å‘è½¯é“¾æ¥è€Œéå…·ä½“ç‰ˆæœ¬ç›®å½•
- éƒ¨ç½²è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œé»˜è®¤ä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬

## æ•…éšœæ’é™¤

### æ‰¾ä¸åˆ° pcli-cd å‘½ä»¤

```bash
# æ£€æŸ¥æ˜¯å¦æ­£ç¡®å®‰è£…
npm list -g @noahyu/cd-cli

# é‡æ–°å®‰è£…
npm install -g @noahyu/cd-cli
```

### é…ç½®æ–‡ä»¶é”™è¯¯

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls pcli-cd.config.js

# é‡æ–°åˆå§‹åŒ–é…ç½®
pcli-cd init
```

## License

MIT
